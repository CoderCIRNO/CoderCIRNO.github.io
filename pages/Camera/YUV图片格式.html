
<html lang="zh-cn">
    <head>
        <meta content="text/html; charset=utf-8" http-equiv="content-type" />
        <title>YUV图片格式</title>
        <link href="../../css/default.css" rel="stylesheet">
    </head>
    <body>
        <h1 id="yuv">YUV图片格式</h1>
<p>YUV是图片、相机、视频中会用到的一种图像格式，Y(Luminance)表示亮度，U(Chrominance)表示色度，V(Chroma)表示浓度。</p>
<p>YUV根据Y、U、V在水平、垂直方向的采样率之比又分为yuv444、yuv422和yuv420，不同的格式存储方式也略有不同，本文我们以yuv420为例。</p>
<p>yuv420格式中，Y和UV在水平和垂直方向采样率之比都是2：1，这意味着yuv420一定会损失部分色彩信息。</p>
<p>Y、U、V分量的存储空间占用比为4:1\:1，存储顺序则是按像素从左到右横向扫描，先存储所有Y分量，再存储所有U分量，最后存储所有V分量，每个分量占一个字节，也就是8bit。</p>
<p>如果有一个4x4的yuv420p图片，其24B存储空间的大致分布将如下所示：</p>
<table>
<thead>
<tr>
<th><strong>Y</strong></th>
<th><strong>Y</strong></th>
<th><strong>Y</strong></th>
<th><strong>Y</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
</tr>
<tr>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
</tr>
<tr>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
</tr>
<tr>
<td><strong>V</strong></td>
<td><strong>V</strong></td>
<td><strong>V</strong></td>
<td><strong>V</strong></td>
</tr>
<tr>
<td><strong>U</strong></td>
<td><strong>U</strong></td>
<td><strong>U</strong></td>
<td><strong>U</strong></td>
</tr>
</tbody>
</table>
<p>Y分量占据了16个字节，U、V分量分别占据4个字节。并不需要知道这些UV是如何反映到每个像素上的，知道大致存储结构就已经可以对图像进行消色操作了。</p>
<p>如果我们只获取Y分量，那么我们就能得到一副黑白画面，如果除Y分量还额外获取UV分量，就能得到彩色画面。这也是为什么电视信号能同时兼容彩电和黑白电视，因为电视信号就是用这种存储方式传输画面。</p>
<h2 id="yuv_1"><strong>生成与查看YUV图片</strong></h2>
<p>要转换yuv格式和查看yuv图片，需要安装ffmpeg。</p>
<p>yuv格式并没有文件头，无法从文件内容中获知图片尺寸信息，必须人为指定。</p>
<p>因此建议在命名yuv文件时，在文件名中注明图片尺寸，以便后续使用。</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#安装ffmpeg</span>
$ sudo apt install ffmpeg

<span class="c1">#将图片尺寸为384x182的TestPic.png转换为yuv420格式的图片out_384x182.yuv</span>
$ ffmpeg -i TestPic.png -s 384x182 -pix_fmt yuv420p out_384x182.yuv

<span class="c1">#查看尺寸为384x182的yuv格式图片out_384x182.yuv</span>
$ ffplay -f rawvideo -video_size 384x182 out_384x182.yuv
</code></pre></div>

<h2 id="_1"><strong>图像消色实验</strong></h2>
<p>通过C++的文件读写操作，可以很轻易的按字节操作yuv文件。</p>
<p>用 <strong>0x80</strong> （-128）覆盖UV分量即可消除对应的色彩信息。</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;iomanip&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;fstream&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;thread&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;dirent.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;utility&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;chrono&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;android/log.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;utils/CallStack.h&gt;</span><span class="cp"></span>

<span class="c1">//&lt;utils/CallStack.h&gt; refers &lt;log/log.h&gt;, in &lt;log/log.h&gt; defined  LOG_TAG to NULL</span>
<span class="cp">#undef LOG_TAG</span>
<span class="cp">#define LOG_TAG &quot;wangtianlin1&quot;</span>
<span class="cp">#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG,LOG_TAG ,__VA_ARGS__)</span>
<span class="cp">#define LOGI(...) __android_log_print(ANDROID_LOG_INFO,LOG_TAG ,__VA_ARGS__)</span>

<span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">WIDTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1844</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">HEIGTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">BUFFER_CAPACITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">INPUT_FOLDER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;input//&quot;</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">OUTPUT_FOLDER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;output//&quot;</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">FILE_TYPE_NUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="n">android</span><span class="o">::</span><span class="n">CallStack</span><span class="w"> </span><span class="n">g_callStack</span><span class="p">;</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">dump_stack_android</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">g_callStack</span><span class="p">.</span><span class="n">update</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">g_callStack</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">DataQueue</span><span class="p">{</span><span class="w"></span>
<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">DataQueue</span><span class="p">(){</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">readDone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">writeDone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">//Add a node at queue tail.</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Product</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">inputData</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">inputLength</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tail</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DataNode</span><span class="p">(</span><span class="n">inputData</span><span class="p">,</span><span class="w"> </span><span class="n">inputLength</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">_next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DataNode</span><span class="p">(</span><span class="n">inputData</span><span class="p">,</span><span class="w"> </span><span class="n">inputLength</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">//Get a node at queue head and delete it, if head is null, keep waitting.</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Consume</span><span class="p">(){</span><span class="w"></span>
<span class="w">        </span><span class="c1">//Consumer is allowed to wait.</span>
<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">_data</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">_length</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">DataNode</span><span class="o">*</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">DataNode</span><span class="o">*</span><span class="p">)</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">//Another wait.</span>
<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">_next</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">readDone</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/*///////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cm">        //</span>
<span class="cm">        //    Three situations : (next) || (done) || (next &amp;&amp; done)</span>
<span class="cm">        //    next: strill reading.</span>
<span class="cm">        //    done: read finished and data is empty. Writting should stop at this situation.</span>
<span class="cm">        //    next &amp;&amp; done: read finished but data is not empty.</span>
<span class="cm">        //</span>
<span class="cm">        ///////////////////////////////////////////////////////////////////////////////////////////////*/</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">//read done and write done.</span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">writeDone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Child Thread - Write Finished.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">dump_stack_android</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">delete</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">SetReadDone</span><span class="p">(){</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">readDone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">IsWriteDone</span><span class="p">(){</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">writeDone</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">DataNode</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n">_data</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">_length</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">DataNode</span><span class="o">*</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n">_next</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">DataNode</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">inputData</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">inputLength</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="n">_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputData</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputLength</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">_next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">DataNode</span><span class="o">*</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n">head</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">DataNode</span><span class="o">*</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n">tail</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">readDone</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">writeDone</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="n">DataQueue</span><span class="o">*</span><span class="w"> </span><span class="n">g_DQ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DataQueue</span><span class="p">();</span><span class="w"></span>

<span class="c1">//Open INPUT_FOLDER and create a string vector by all files</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">CreateFileNameVector</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">inputStringVector</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kt">DIR</span><span class="o">*</span><span class="w"> </span><span class="n">dir</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dirent</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;input//&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opendir</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">()))){</span><span class="w"></span>
<span class="w">        </span><span class="n">LOGI</span><span class="p">(</span><span class="s">&quot;Main  Thread - No input file found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="p">((</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">FILE_TYPE_NUM</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">d_type</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">inputStringVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">//Read BUFFER_CAPACITY Byte once from yuv file and deliver it to writer thread, skip -</span>
<span class="c1">//color informations(UV).</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">PicDataRead</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">ReadByteNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WIDTH</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HEIGTH</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fileNames</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">CreateFileNameVector</span><span class="p">(</span><span class="n">fileNames</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">currentFileName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">fileNames</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="w"> </span><span class="n">picReader</span><span class="p">(</span><span class="n">INPUT_FOLDER</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">currentFileName</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="o">::</span><span class="n">binary</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">currentFileName</span><span class="p">.</span><span class="n">size</span><span class="p">()];</span><span class="w"></span>
<span class="w">        </span><span class="n">strcpy</span><span class="p">(</span><span class="n">_temp</span><span class="p">,</span><span class="w"> </span><span class="n">currentFileName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">picReader</span><span class="p">.</span><span class="n">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">picReader</span><span class="p">.</span><span class="n">end</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">PicSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picReader</span><span class="p">.</span><span class="n">tellg</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">picReader</span><span class="p">.</span><span class="n">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">picReader</span><span class="p">.</span><span class="n">beg</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">g_DQ</span><span class="o">-&gt;</span><span class="n">Product</span><span class="p">(</span><span class="n">_temp</span><span class="p">,</span><span class="w"> </span><span class="n">PicSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ReadByteNum</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Main  Thread - File %s reading...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">currentFileName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">readCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">readCounter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ReadByteNum</span><span class="p">;){</span><span class="w"></span>
<span class="w">            </span><span class="n">uint</span><span class="w"> </span><span class="n">_bufferLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadByteNum</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">readCounter</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">uint</span><span class="w"> </span><span class="n">_currentBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUFFER_CAPACITY</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">_bufferLeft</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BUFFER_CAPACITY</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="n">_currentBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_bufferLeft</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">inputData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">_currentBufferSize</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="n">picReader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">inputData</span><span class="p">,</span><span class="w"> </span><span class="n">_currentBufferSize</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">g_DQ</span><span class="o">-&gt;</span><span class="n">Product</span><span class="p">(</span><span class="n">inputData</span><span class="p">,</span><span class="w"> </span><span class="n">_currentBufferSize</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">readCounter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">_currentBufferSize</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">picReader</span><span class="p">.</span><span class="n">close</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Main  Thread - File %s reading done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">currentFileName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">g_DQ</span><span class="o">-&gt;</span><span class="n">SetReadDone</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Main  Thread - Read Finished!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//Write information received to file, and fill color information with 0x80.</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">PicDataWrite</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">WriteByteNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WIDTH</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HEIGTH</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">grayBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">BUFFER_CAPACITY</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">grayBuffer</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="n">BUFFER_CAPACITY</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Child Thread - Getting file name and bufferLeftNum...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">resultReceiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_DQ</span><span class="o">-&gt;</span><span class="n">Consume</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">currentFileName</span><span class="p">(</span><span class="n">resultReceiver</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">bufferLeftNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resultReceiver</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Child Thread - File name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w">  </span><span class="n">currentFileName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">delete</span><span class="p">[](</span><span class="n">resultReceiver</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="w"> </span><span class="n">picOutput</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">currentFileName</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="o">::</span><span class="n">binary</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Child Thread - File %s writing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">currentFileName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">writeCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">writeCounter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">WriteByteNum</span><span class="p">;){</span><span class="w"></span>
<span class="w">            </span><span class="n">resultReceiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_DQ</span><span class="o">-&gt;</span><span class="n">Consume</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">picOutput</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">resultReceiver</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">resultReceiver</span><span class="p">.</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">delete</span><span class="p">[](</span><span class="n">resultReceiver</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">writeCounter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">resultReceiver</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">writeCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">writeCounter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bufferLeftNum</span><span class="p">;){</span><span class="w"></span>
<span class="w">            </span><span class="n">uint</span><span class="w"> </span><span class="n">_bufferLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufferLeftNum</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">writeCounter</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">uint</span><span class="w"> </span><span class="n">_currentBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUFFER_CAPACITY</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">_bufferLeft</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BUFFER_CAPACITY</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="n">_currentBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_bufferLeft</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">picOutput</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">grayBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">_currentBufferSize</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">writeCounter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">_currentBufferSize</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">picOutput</span><span class="p">.</span><span class="n">close</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Child Thread - File %s writing done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">currentFileName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">g_DQ</span><span class="o">-&gt;</span><span class="n">IsWriteDone</span><span class="p">()){</span><span class="w"></span>
<span class="w">            </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Child Thread - All file processed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">delete</span><span class="p">[](</span><span class="n">grayBuffer</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Main  Thread - #######Start#######</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="w"> </span><span class="n">t_writer</span><span class="p">(</span><span class="n">PicDataWrite</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">PicDataRead</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Main  Thread - Waitting child thread...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">t_writer</span><span class="p">.</span><span class="n">join</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">endTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">startTime</span><span class="p">).</span><span class="n">count</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Main  Thread - All time consumed %.3f  ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-3</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Main  Thread - ####### End #######</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
    </body>
</html>
